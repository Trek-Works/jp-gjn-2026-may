<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaving TrekWorks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #05060b;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      max-width: 440px;
      padding: 28px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      text-align: center;
    }

    h1 {
      font-size: 1.35rem;
      margin-bottom: 12px;
    }

    p {
      opacity: 0.85;
      line-height: 1.5;
      margin: 0 0 8px 0;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    a.button {
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 10px;
      background: rgba(255,255,255,0.12);
      color: #ffffff;
      font-weight: 500;
    }

    .offline-icon {
      font-size: 46px;
      margin-bottom: 10px;
    }

    .footer {
      margin-top: 18px;
      font-size: 0.9rem;
      opacity: 0.6;
    }
  </style>
</head>

<body>

<div class="card" id="card">
  <h1>Checking connectionâ€¦</h1>
  <p>Please wait</p>
</div>

<script>
/* ======================================================
   Trip Mode â€” JP Â· GJN-2026-May (canonical, rebased)
   ====================================================== */

const TRIP_MODE_KEY = "tripMode:GJN-2026-May";
const TRIP_MODE_LS_KEY = "trekworks.tripMode:GJN-2026-May";

function getTripMode() {
  return new Promise((resolve) => {
    const req = indexedDB.open("trekworks", 1);

    req.onerror = () => resolve("offline");

    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("settings")) {
        db.createObjectStore("settings");
      }
    };

    req.onsuccess = () => {
      try {
        const db = req.result;
        const tx = db.transaction("settings", "readonly");
        const store = tx.objectStore("settings");
        const r = store.get(TRIP_MODE_KEY);

        r.onsuccess = () => {
          if (r.result === undefined && localStorage.getItem(TRIP_MODE_LS_KEY)) {
            store.put(localStorage.getItem(TRIP_MODE_LS_KEY), TRIP_MODE_KEY);
          }
          resolve(r.result || "offline");
        };

        r.onerror = () => resolve("offline");
      } catch {
        resolve("offline");
      }
    };
  });
}

/* ======================================================
   Connectivity check
   ====================================================== */

async function hasConnection() {
  if (!navigator.onLine) return false;
  try {
    await fetch("https://www.google.com/generate_204", {
      method: "GET",
      mode: "no-cors",
      cache: "no-store"
    });
    return true;
  } catch {
    return false;
  }
}

/* ======================================================
   Navigation helpers
   ====================================================== */

function goBackSafely() {
  if (history.length > 1) {
    history.back();
  } else {
    location.href = "./index.html";
  }
}

/* ======================================================
   Render helpers
   ====================================================== */

function renderOffline() {
  document.getElementById("card").innerHTML = `
    <div class="offline-icon">ðŸ“´</div>
    <h1>External link unavailable</h1>
    <p>You appear to be offline.</p>
    <div class="actions">
      <a class="button" href="./index.html">Back to Trip Home</a>
      <a class="button" href="#" onclick="goBackSafely(); return false;">Go Back</a>
    </div>
    <div class="footer">JP Â· GJN-2026-May Â· Japan</div>
  `;
}

function renderBlocked() {
  document.getElementById("card").innerHTML = `
    <h1>External access blocked</h1>
    <p>You are currently in Offline Trip Mode.</p>
    <div class="actions">
      <a class="button" href="./index.html">Back to Trip Home</a>
      <a class="button" href="#" onclick="goBackSafely(); return false;">Go Back</a>
    </div>
    <div class="footer">JP Â· GJN-2026-May Â· Japan</div>
  `;
}

function renderInvalid() {
  document.getElementById("card").innerHTML = `
    <h1>External link unavailable</h1>
    <p>Invalid external link.</p>
    <div class="actions">
      <a class="button" href="./index.html">Back to Trip Home</a>
      <a class="button" href="#" onclick="goBackSafely(); return false;">Go Back</a>
    </div>
    <div class="footer">JP Â· GJN-2026-May Â· Japan</div>
  `;
}

/* ======================================================
   Main execution
   ====================================================== */

(async () => {
  const params = new URLSearchParams(location.search);
  const targetUrl = params.get("url");

  if (!targetUrl) {
    renderInvalid();
    return;
  }

  const online = await hasConnection();
  if (!online) {
    renderOffline();
    return;
  }

  const tripMode = await getTripMode();
  if (tripMode !== "online") {
    renderBlocked();
    return;
  }

  location.replace(targetUrl);
})();
</script>

</body>
</html>
